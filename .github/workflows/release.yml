name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Build cross-platform
        env:
          CGO_ENABLED: 0
          APP: photosort
          SRC: ./cmd/photosort
        run: |
          set -e
          mkdir -p dist
          build() {
            GOOS="$1"; GOARCH="$2"; EXT=""
            [ "$GOOS" = "windows" ] && EXT=".exe"
            OUT="dist/${APP}-${GOOS}-${GOARCH}${EXT}"
            echo "-> $OUT"
            GOOS=$GOOS GOARCH=$GOARCH go build -trimpath -ldflags "-s -w" -o "$OUT" "$SRC"
          }
          build darwin arm64
          build windows amd64

      - name: Package artifacts
        run: |
          set -e
          cd dist
          # macOS: tar.gz、Windows: zip
          tar -czf photosort-darwin-arm64.tar.gz photosort-darwin-arm64
          zip -9 photosort-windows-amd64.zip photosort-windows-amd64.exe
          # checksums
          sha256sum *.tar.gz *.zip > checksums.txt
          ls -l

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: |
            dist/photosort-darwin-arm64.tar.gz
            dist/photosort-windows-amd64.zip
            dist/checksums.txt
